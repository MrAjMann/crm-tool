<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<link href="/css/output.css" rel="stylesheet" />
		<link
			rel="stylesheet"
			href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
		/>
		<title>Data on the Downs - Create New Invoice</title>
	</head>
	<body class="flex bg-gray-100 ">
		<div class="bg-gray-800 text-white  space-y-6 py-7 px-2">
			<!-- Sidebar content -->
			{{template "sidebar.html"}}
		</div>

		<div class="flex-grow flex flex-col">
			<!-- TopBar -->
			<div class="bg-gray-800 text-white w-full">
			<div class="mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
					<!-- <h1 class="text-lg font-semibold">Create Invoice</h1> -->
				
				</div>
			</div>
			<div id="modal-container" ></div>
			<div class="flex-1 ">
				<div class="container mx-auto p-4 ">
					<h1 class="text-3xl font-semibold mb-4">Create Invoice</h1>
					<div class="bg-white shadow-md rounded-lg p-3  ">
						<form id="invoiceForm" class="space-y-6 px-12 mx-auto">
							<!-- Due Date above Customer Search -->
							<div class="flex flex-col">
								<label class="w-40  py-1 text-gray-800 font-medium" for="DueDate">Due Date:</label>
								<input
									type="date"
									name="DueDate"
									id="invoice-DueDate"
									class="w-40 px-4 py-1 border rounded-lg shadow-md"
									placeholder="Due Date"
									style="background-color: #f3f4f6; border: 1px solid #d1d5db;"
								/>
							</div>

							<!-- Customer search -->
	<!-- Customer search -->

<div class="mb-4">
    <label class="w-40 py-1 text-gray-800 font-medium" for="DueDate">Search Customers:</label>
    <div class="flex items-center space-x-3">
        <input 
            type="text" 
            id="customerSearch"
            class="text-gray-800 border w-full border-gray-200 outline-gray-400 shadow-md rounded-lg p-3"
            placeholder="Start typing to search for a customer..." 
            hx-get="/search-customers"
            hx-trigger="keyup changed"
            hx-target="#customerSearchResults"
            hx-swap="innerHTML"
            hx-params="search"
            name="search"
        />
        <button 
		type="text" 
		id="add-customer"
		hx-get="/create-customer-modal"
		hx-trigger="click"
		hx-target="#modal-container"
		hx-swap="innerHTML"
            class="mx-auto inline-flex items-center px-4 py-2 flex-nowrap justify-center items-center-center bg-green-500 border border-transparent rounded-md font-semibold text-xs text-white uppercase tracking-wide hover:bg-green-600 active:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition ease-in-out duration-150">
            <i class="fas fa-user-plus mr-2 fa-lg" ></i> Add Customer
        </button>
    </div>
    <div id="customerSearchResults"></div>
	<div id="modal-container" class="overlay"></div>
</div>
							
						
							<!-- Items Section -->
							<div id="itemsSection" class="shadow-md rounded-lg p-4">
								<table class="min-w-full leading-normal">
									<thead>
										<tr class="text-left text-sm font-semibold tracking-wider border-b border-gray-200">
											<th class="px-5 py-3">Item</th>
											<th class="px-5 py-3">Quantity</th>
											<th class="px-5 py-3">Unit Price</th>
											<th class="px-5 py-3">Subtotal</th>
											<th class="px-5 py-3">Tax</th>
											<th class="px-5 py-3">Total</th>
											<th class="px-5 py-3">Action</th>
										</tr>
									</thead>
									<tbody>
										<tr class="item-row bg-gray-100 border-b">
											<td class="px-5 py-5"><input type="text" name="items[0].Item" class="w-full px-3 py-1 border rounded-lg item-name" placeholder="Item"/></td>
											<td class="px-5 py-5">
												<input type="number" name="items[0].Quantity" class="w-full px-3 py-1 border rounded-lg item-quantity" hx-post="/calculate-invoice" hx-trigger="keyup changed delay:500ms" hx-include="closest tr" placeholder="0"/>
											</td>
											<td class="px-5 py-5">
												<input type="number" name="items[0].UnitPrice" class="w-full px-3 py-1 border rounded-lg item-unitPrice" hx-post="/calculate-invoice" hx-trigger="keyup changed delay:500ms" hx-include="closest tr" placeholder="0.00"/>
											</td>
											<td class="px-5 py-5"><input type="number" name="items[0].Subtotal" class="w-full px-3 py-1 border rounded-lg item-subtotal" placeholder="0.00" readonly/></td>
											<td class="px-5 py-5"><input type="number" name="items[0].Tax" class="w-full px-3 py-1 border rounded-lg item-tax" placeholder="0.00" readonly/></td>
											<td class="px-5 py-5"><input type="number" name="items[0].Total" class="w-full px-3 py-1 border rounded-lg item-total" placeholder="0.00" readonly/></td>
										</tr>
									</tbody>
								</table>
							</div>

							<!-- Submit and Close Buttons -->
							<div class="flex justify-end space-x-4">
								<button
									type="submit"
									class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-1 px-4 rounded"
								>
									Submit
								</button>
								<button
									type="button"
									onclick="closeModal()"
									class="bg-red-500 hover:bg-red-700 text-white font-bold py-1 px-4 rounded"
								>
									Cancel
								</button>
							</div>
						</form>
					</div>
				</div>
			</div>
		</div>
		<script src="https://unpkg.com/htmx.org"></script>
		<script>
document.body.addEventListener('htmx:afterOnLoad', function(event) {
    var response = event.detail.xhr.responseText;
    var row = event.detail.elt.closest('.item-row');
	console.log("row", row)
	console.log("response", response)
    if (response && response.subtotal !== undefined && response.tax !== undefined && response.total !== undefined) {
        row.querySelector('.item-subtotal').value = response.subtotal.toFixed(2);
        row.querySelector('.item-tax').value = response.tax.toFixed(2);
        row.querySelector('.item-total').value = response.total.toFixed(2);
		row.innerHTML = response;
    } else {
        console.error('Invalid response:', response);
    }
});
</script>
		<script>
document.addEventListener('DOMContentLoaded', function() {
    const itemsSection = document.querySelector('#itemsSection tbody');

	let itemCount = itemsSection.querySelectorAll('tr').length;  

    itemsSection.addEventListener('click', function(event) {
        if (event.target.classList.contains('add-item-btn')) {
            const lastRow = event.target.closest('tr');
            const clone = lastRow.cloneNode(true);
            clone.querySelectorAll('input').forEach(input => {
                const nameBase = input.name.match(/^[^\[]+/)[0]; // Strip indices
                input.name = `${nameBase}[${itemCount}]`; // Update with new index
                input.value = ''; // Clear values
            });
            const actionCell = clone.querySelector('td:last-child');
            actionCell.innerHTML = '<button type="button" class="delete-item-btn bg-red-500 hover:bg-red-700 text-white font-bold py-1 px-4 rounded"><i class="fas fa-trash"></i></button>';
            itemsSection.appendChild(clone);
            itemCount++; // Increment the counter
        } else if (event.target.classList.contains('delete-item-btn')) {
            const row = event.target.closest('tr');
            row.remove();
            updateItemIndexes();
        }
    });

    function updateItemIndexes() {
        const rows = itemsSection.querySelectorAll('tr');
        rows.forEach((row, index) => {
            row.querySelectorAll('input').forEach(input => {
                const nameBase = input.name.match(/^[^\[]+/)[0];
                input.name = `${nameBase}[${index}]`;
            });
        });
    }
});

</script>

	</body>
</html>
